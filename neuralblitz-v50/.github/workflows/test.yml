# NeuralBlitz v50.0 - Test Workflow
# Runs tests for Python, Go, and Rust implementations
# GoldenDAG: a8d0f2a4c6b8d0f2a4c6b8d0f2a4c6b8d0f2a4c6b8d0f2a4c6b8d0f2a4c6b8d0

name: Test All Implementations

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-python:
    name: Test Python Implementation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./python
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install -e .
        pip install pytest pytest-cov black mypy
    
    - name: Run type checker
      run: mypy neuralblitz/ --ignore-missing-imports || true
    
    - name: Run tests with coverage
      run: pytest tests/ -v --cov=neuralblitz --cov-report=xml --cov-report=term
    
    - name: Check code formatting
      run: black --check neuralblitz/ || true
    
    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        files: ./python/coverage.xml
        flags: python
        name: python-coverage

  test-go:
    name: Test Go Implementation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./go
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go 1.21
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
    
    - name: Install dependencies
      run: go mod download
    
    - name: Run tests
      run: go test -v ./... -race -coverprofile=coverage.out
    
    - name: Generate coverage report
      run: go tool cover -html=coverage.out -o coverage.html
    
    - name: Check formatting
      run: |
        if [ "$(gofmt -l . | wc -l)" -gt 0 ]; then
          echo "Go code is not formatted:"
          gofmt -l .
          exit 1
        fi
    
    - name: Run linter
      uses: golangci/golangci-lint-action@v3
      with:
        version: latest
        working-directory: go
        args: --timeout=5m

  test-rust:
    name: Test Rust Implementation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./rust
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy
    
    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: rust
    
    - name: Check formatting
      run: cargo fmt -- --check
    
    - name: Run Clippy
      run: cargo clippy -- -D warnings || true
    
    - name: Run tests
      run: cargo test --verbose
    
    - name: Build release
      run: cargo build --release --verbose

  test-docker:
    name: Test Docker Builds
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Python images
      run: |
        cd docker
        docker build -f Dockerfile.python --target option-e -t nb-python:e ..
        docker build -f Dockerfile.python --target option-f -t nb-python:f ..
    
    - name: Build Go images
      run: |
        cd docker
        docker build -f Dockerfile.go --target option-f -t nb-go:f ..
    
    - name: Build Rust images
      run: |
        cd docker
        docker build -f Dockerfile.rust --target option-f -t nb-rust:f ..
    
    - name: Test Python CLI
      run: docker run --rm nb-python:e nbcl /status

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test-python, test-go, test-rust]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Compose
      run: |
        cd docker
        docker compose -f docker-compose.yml config
    
    - name: Test compose build
      run: |
        cd docker
        docker compose build --parallel
