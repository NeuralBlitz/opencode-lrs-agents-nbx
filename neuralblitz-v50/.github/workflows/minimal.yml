# NeuralBlitz V50 Minimal - CI/CD Workflow
# Runs tests for the minimal implementation

name: Test Minimal Implementation

on:
  push:
    branches: [ main, develop, minimal ]
    paths:
      - 'neuralblitz/minimal.py'
      - 'neuralblitz/__init__.py'
      - 'neuralblitz/advanced.py'
      - 'tests/test_minimal.py'
      - 'examples/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'neuralblitz/**'
      - 'tests/**'
  workflow_dispatch:

jobs:
  test-minimal:
    name: Test Minimal Implementation
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install minimal dependencies
      run: |
        pip install numpy
        pip install pytest pytest-cov
    
    - name: Run minimal tests
      run: |
        pytest tests/test_minimal.py -v --cov=neuralblitz --cov-report=xml
    
    - name: Test imports
      run: |
        python -c "from neuralblitz import MinimalCognitiveEngine, IntentVector; print('✓ Imports OK')"
        python -c "from neuralblitz.minimal import MinimalCognitiveEngine; print('✓ Direct import OK')"
    
    - name: Run examples
      run: |
        python examples/01_basic_usage.py
        python examples/04_intent_comparison.py
    
    - name: Performance benchmark
      run: |
        python -c "
        import time
        from neuralblitz import MinimalCognitiveEngine, IntentVector
        engine = MinimalCognitiveEngine()
        start = time.time()
        for i in range(1000):
            intent = IntentVector(phi1_dominance=i/1000)
            engine.process_intent(intent)
        elapsed = (time.time() - start) * 1000
        print(f'1000 intents in {elapsed:.1f}ms ({elapsed/1000:.2f}ms each)')
        assert elapsed < 2000, f'Too slow: {elapsed}ms > 2000ms'
        print('✓ Performance OK')
        "
    
    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml
        flags: minimal
        name: minimal-python${{ matrix.python-version }}

  test-advanced:
    name: Test Advanced Features
    runs-on: ubuntu-latest
    needs: test-minimal
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install numpy pytest
    
    - name: Test advanced imports
      run: |
        python -c "from neuralblitz.advanced import AsyncCognitiveEngine; print('✓ AsyncCognitiveEngine imported')"
        python -c "from neuralblitz.advanced import ConsciousnessMonitor; print('✓ ConsciousnessMonitor imported')"
    
    - name: Run async examples
      run: |
        python examples/02_async_processing.py || echo "Async example requires fixes"
        python examples/03_consciousness_monitoring.py

  lint-minimal:
    name: Lint Minimal Code
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install linting tools
      run: |
        pip install black isort flake8 mypy
    
    - name: Check formatting
      run: |
        black --check neuralblitz/minimal.py neuralblitz/advanced.py || true
    
    - name: Check imports
      run: |
        isort --check-only neuralblitz/minimal.py neuralblitz/advanced.py || true
    
    - name: Run flake8
      run: |
        flake8 neuralblitz/minimal.py neuralblitz/advanced.py --max-line-length=100 || true
    
    - name: Type check
      run: |
        mypy neuralblitz/minimal.py --ignore-missing-imports || true